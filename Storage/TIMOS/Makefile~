default: test

include ../CommonParser/Makefile.in

#hoomans addition -msse4 -mavx -march=native, changing cxx-opts
CXX_OPTS=-Wall -msse4 -mavx  -fPIC -O3 -g -std=c++11 -c -I$(SOURCE_ROOT) 

CXX_LIB_OPTS=-Wall -msse4 -mavx  -fPIC -shared -O3 -mavx -Wa,-q 
CXX=g++

libs: libFullMonteTIMOS.so libFullMonteTIMOS_TCL.so

Test.o: Test.cpp TIMOSLexer.h TIMOSParser.h
	$(CXX) $(CXX_OPTS) -I$(ANTLR_INCLUDE) $<
	
%.o: %.cpp TIMOS_tokens.h
	$(CXX) $(CXX_OPTS) -I$(ANTLR_INCLUDE) $<

libFullMonteTIMOS.so: TIMOSParser.o TIMOSLexer.o TIMOSReader.o TIMOSWriter.o | TIMOS_tokens.h
	$(CXX) $(CXX_LIB_OPTS) -L$(ANTLR_LIB)  -L../../Geometry -lantlr3c -lFullMonteGeometry -o $@ $^
	
FullMonteTIMOS_wrap.cxx: FullMonteTIMOS.i
	$(SWIG) -tcl -c++ -o $@ $<
	
FullMonteTIMOS_wrap.o: FullMonteTIMOS_wrap.cxx
	$(CXX) $(CXX_OPTS) -I$(TCL_INCLUDE) -I$(ANTLR_INCLUDE) -DUSE_TCL_STUBS -c $^
	
libFullMonteTIMOS_TCL.so: FullMonteTIMOS_wrap.o | libFullMonteTIMOS.so
	$(CXX) $(CXX_LIB_OPTS) -I$(ANTLR_LIB) -L$(TCL_LIB) -ltclstub8.5 -L../../Geometry -L. -lFullMonteTIMOS -lFullMonteGeometry -o $@ $^ 

test: Test.o libFullMonteTIMOS.so
	$(CXX) $(CXX_LINK_OPTS) -L$(ANTLR_LIB) -L../../Geometry -L. -lantlr3c -lFullMonteTIMOS -lFullMonteGeometry -o $@ Test.o

clean: parser-clean
	rm -f test *.so *.a *.o *_wrap.cxx *.dSYM
